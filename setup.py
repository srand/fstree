#!/usr/bin/env python3

from setuptools import setup, Extension
from pybind11.setup_helpers import Pybind11Extension, build_ext
import pybind11


# Add our source directories
include_dirs = [
    'src',
    'build',  # For generated protobuf files
    'build/src',
    "sysroot/include",
    pybind11.get_cmake_dir() + '/../include'
]

# Library directories
library_dirs = [
    'sysroot/lib',
    'sysroot/lib64',
]

# Libraries
libraries = [
    "fstree",
    'blake3',
    "grpc++",
    "grpc",
    "curl",
    "protobuf",
    "zstd",
    "ssl",
    "crypto",
    "brotlidec",
    "brotlicommon",
    "absl_base",
    "absl_city",
    "absl_civil_time",
    "absl_cord",
    "absl_cord_internal",
    "absl_cordz_functions",
    "absl_cordz_handle",
    "absl_cordz_info",
    "absl_cordz_sample_token",
    "absl_crc32c",
    "absl_crc_cord_state",
    "absl_crc_cpu_detect",
    "absl_crc_internal",
    "absl_debugging_internal",
    "absl_decode_rust_punycode",
    "absl_demangle_internal",
    "absl_demangle_rust",
    "absl_die_if_null",
    "absl_examine_stack",
    "absl_exponential_biased",
    "absl_failure_signal_handler",
    "absl_flags_commandlineflag",
    "absl_flags_commandlineflag_internal",
    "absl_flags_config",
    "absl_flags_internal",
    "absl_flags_marshalling",
    "absl_flags_parse",
    "absl_flags_private_handle_accessor",
    "absl_flags_program_name",
    "absl_flags_reflection",
    "absl_flags_usage",
    "absl_flags_usage_internal",
    "absl_graphcycles_internal",
    "absl_hash",
    "absl_hashtable_profiler",
    "absl_hashtablez_sampler",
    "absl_int128",
    "absl_kernel_timeout_internal",
    "absl_leak_check",
    "absl_log_entry",
    "absl_log_flags",
    "absl_log_globals",
    "absl_log_initialize",
    "absl_log_internal_check_op",
    "absl_log_internal_conditions",
    "absl_log_internal_fnmatch",
    "absl_log_internal_format",
    "absl_log_internal_globals",
    "absl_log_internal_log_sink_set",
    "absl_log_internal_message",
    "absl_log_internal_nullguard",
    "absl_log_internal_proto",
    "absl_log_internal_structured_proto",
    "absl_log_severity",
    "absl_log_sink",
    "absl_malloc_internal",
    "absl_periodic_sampler",
    "absl_poison",
    "absl_profile_builder",
    "absl_random_distributions",
    "absl_random_internal_distribution_test_util",
    "absl_random_internal_entropy_pool",
    "absl_random_internal_platform",
    "absl_random_internal_randen",
    "absl_random_internal_randen_hwaes",
    "absl_random_internal_randen_hwaes_impl",
    "absl_random_internal_randen_slow",
    "absl_random_internal_seed_material",
    "absl_random_seed_gen_exception",
    "absl_random_seed_sequences",
    "absl_raw_hash_set",
    "absl_raw_logging_internal",
    "absl_scoped_set_env",
    "absl_spinlock_wait",
    "absl_stacktrace",
    "absl_status",
    "absl_statusor",
    "absl_str_format_internal",
    "absl_strerror",
    "absl_string_view",
    "absl_strings",
    "absl_strings_internal",
    "absl_symbolize",
    "absl_synchronization",
    "absl_throw_delegate",
    "absl_time",
    "absl_time_zone",
    "absl_tracing_internal",
    "absl_utf8_for_code_point",
    "absl_vlog_config_internal",
    "cares",
    "z",
]

# Define the extension
ext_modules = [
    Pybind11Extension(
        "fstree",
        [
            "python/fstree.cpp",
            "python/simple.cpp",
            # "src/argparser.cpp",
            # "src/cache.cpp",
            # "src/commit_ostream.cpp",
            # "src/directory_iterator.cpp",
            # "src/directory_iterator_posix.cpp",
            # "src/directory_iterator_win32.cpp",
            # "src/event.cpp",
            # "src/filesystem_posix.cpp",
            # "src/filesystem_win32.cpp",
            # "src/glob_list.cpp",
            # "src/hash_blake3.cpp",
            # "src/index.cpp",
            # "src/inode.cpp",
            # "src/intrusive_ptr.cpp",
            # "src/lock_file_posix.cpp",
            # "src/lock_file_win32.cpp",
            # "src/remote.cpp",
            # "src/remote_http.cpp",
            # "src/remote_jolt.cpp",
            # "src/status.cpp",
            # "src/thread.cpp",
            # "src/thread_pool.cpp",
        ],
        define_macros=[
            ("FSTREE_HASH_BLAKE3", None), 
            ("FSTREE_ENABLE_HTTP_REMOTE", None),
            ("FSTREE_ENABLE_JOLT_REMOTE", None),
        ],
        include_dirs=include_dirs,
        library_dirs=library_dirs,
        libraries=libraries,
        language='c++',
        cxx_std=20,
    ),
]

setup(
    name="fstree",
    version="0.1.0",
    author="Robert Andersson",
    author_email="rbrtandersson@gmail.com",
    description="Python bindings for fstree - filesystem tree sharing and sync",
    long_description="",
    ext_modules=ext_modules,
    cmdclass={"build_ext": build_ext},
    zip_safe=False,
    python_requires=">=3.7",
    install_requires=[
        "blake3",
        "pybind11",
    ],
)
